<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Add Vehicle - Bells Fork Auto & Truck Admin</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <meta name="robots" content="noindex, nofollow">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- swap to style.min.css after running `npm run build` for production -->
  <link href="style.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      padding-bottom: 3rem;
    }
    .admin-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    .info-badge {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }
    .decoded-data {
      background: #f1f8e9;
      border: 2px solid #8bc34a;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }
    .vehicle-preview {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }
    .btn-decode {
      background: #2196f3;
      color: white;
      border: none;
    }
    .image-preview {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .image-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      border: 2px solid #dee2e6;
    }
    .form-section {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .required-field::after {
      content: " *";
      color: #dc3545;
    }

    /* Hover effects only on hover-capable devices */
    @media (hover: hover) and (pointer: fine) {
  .btn-decode:hover {
      background: #1976d2;
      color: white;
    }
    }

    /* Touch devices: use active states instead of sticky hover */
    @media (hover: none) and (pointer: coarse) {
  .btn-decode:active {
      background: #1976d2;
      color: white;
    }
    }

    @media (max-width: 767px) {
      body { padding-bottom: calc(72px + env(safe-area-inset-bottom)); }
    }

  </style>
</head>
<body>
  <div class="admin-header">
    <div class="container">
      <h1 class="mb-0">
        <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16" class="me-2">
          <rect x="1" y="3" width="15" height="13" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="5.5" cy="14.5" r="1.5" fill="currentColor"/>
          <circle cx="12.5" cy="14.5" r="1.5" fill="currentColor"/>
        </svg>
        Add New Vehicle
      </h1>
      <p class="mb-0 mt-2 opacity-75">Decode VIN and add vehicle to inventory</p>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <!-- VIN Decoder Section -->
        <div class="form-section">
          <h2 class="h4 mb-3">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
            </svg>
            Step 1: Decode VIN
          </h2>
          
          <div class="info-badge">
            <strong>ðŸ’¡ How it works:</strong> Enter the 17-character VIN number and click "Decode VIN" to automatically retrieve vehicle details from the NHTSA database.
          </div>

          <div class="mb-4">
            <label for="vin" class="form-label fw-bold required-field">VIN Number</label>
            <div class="input-group input-group-lg">
              <input 
                type="text" 
                class="form-control text-uppercase" 
                id="vin" 
                placeholder="1FTFW1ET5DFC10312"
                maxlength="17"
                required
                style="font-family: monospace; letter-spacing: 1px;"
              >
              <button class="btn btn-decode px-4" type="button" id="decodeBtn">
                <span class="spinner-border spinner-border-sm me-2 d-none" id="decodeSpinner"></span>
                Decode VIN
              </button>
            </div>
            <div class="form-text">VIN must be exactly 17 characters</div>
            <div class="invalid-feedback" id="vinError"></div>
          </div>

          <!-- Decoded Data Display -->
          <div id="decodedData" class="decoded-data d-none">
            <h5 class="text-success mb-3">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01-.622-.636zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708z"/>
              </svg>
              VIN Decoded Successfully
            </h5>
            <div class="row g-3">
              <div class="col-md-3">
                <small class="text-muted d-block">Year</small>
                <strong id="decodedYear">-</strong>
              </div>
              <div class="col-md-3">
                <small class="text-muted d-block">Make</small>
                <strong id="decodedMake">-</strong>
              </div>
              <div class="col-md-3">
                <small class="text-muted d-block">Model</small>
                <strong id="decodedModel">-</strong>
              </div>
              <div class="col-md-3">
                <small class="text-muted d-block">Trim</small>
                <strong id="decodedTrim">-</strong>
              </div>
              <div class="col-md-4">
                <small class="text-muted d-block">Body Style</small>
                <strong id="decodedBody">-</strong>
              </div>
              <div class="col-md-4">
                <small class="text-muted d-block">Drive Type</small>
                <strong id="decodedDrive">-</strong>
              </div>
              <div class="col-md-4">
                <small class="text-muted d-block">Fuel Type</small>
                <strong id="decodedFuel">-</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Vehicle Details Form -->
        <form id="vehicleForm" class="form-section">
          <h2 class="h4 mb-4">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
              <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
              <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
            </svg>
            Step 2: Add Vehicle Details
          </h2>

          <!-- Basic Info (Auto-filled from VIN) -->
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <label class="form-label fw-bold required-field">Year</label>
              <input type="number" class="form-control" id="year" required min="1990" max="2026">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold required-field">Make</label>
              <input type="text" class="form-control" id="make" required>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold required-field">Model</label>
              <input type="text" class="form-control" id="model" required>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">Trim</label>
              <input type="text" class="form-control" id="trim">
            </div>
          </div>

          <!-- Pricing & Mileage -->
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label fw-bold required-field">Price ($)</label>
              <input type="number" class="form-control" id="price" required min="0" step="100" placeholder="18900">
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold required-field">Mileage</label>
              <input type="number" class="form-control" id="mileage" required min="0" step="1000" placeholder="45000">
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold required-field">Vehicle Type</label>
              <select class="form-select" id="type" required>
                <option value="">Select type...</option>
                <option value="car">Car / Sedan</option>
                <option value="truck">Truck</option>
                <option value="suv">SUV / Crossover</option>
                <option value="diesel">Diesel Vehicle</option>
                <option value="van">Van / Minivan</option>
              </select>
            </div>
          </div>

          <!-- Additional Details -->
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label fw-bold">Exterior Color</label>
              <input type="text" class="form-control" id="exteriorColor" placeholder="Black">
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">Interior Color</label>
              <input type="text" class="form-control" id="interiorColor" placeholder="Gray">
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">Transmission</label>
              <select class="form-select" id="transmission">
                <option value="">Select...</option>
                <option value="Automatic">Automatic</option>
                <option value="Manual">Manual</option>
                <option value="CVT">CVT</option>
              </select>
            </div>
          </div>

          <!-- Description -->
          <div class="mb-4">
            <label class="form-label fw-bold required-field">Description</label>
            <textarea class="form-control" id="description" rows="3" required placeholder="4WD SuperCrew, 5.0L V8, clean interior, well maintained"></textarea>
            <div class="form-text">Brief description that will appear on the vehicle card</div>
          </div>

          <!-- Features/Tags -->
          <div class="mb-4">
            <label class="form-label fw-bold">Features & Tags</label>
            <div class="form-text mb-2">Enter tags separated by commas (e.g., 4WD, V8, Backup Camera, Low Miles)</div>
            <input type="text" class="form-control" id="features" placeholder="4WD, V8, Backup Camera, Bluetooth">
          </div>

          <!-- Badge/Status -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-bold">Badge (Optional)</label>
              <select class="form-select" id="badge">
                <option value="">No Badge</option>
                <option value="Great Value">Great Value</option>
                <option value="Low Miles">Low Miles</option>
                <option value="Diesel">Diesel</option>
                <option value="One Owner">One Owner</option>
                <option value="Recently Added">Recently Added</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Status</label>
              <select class="form-select" id="status">
                <option value="available">Available</option>
                <option value="pending">Pending Sale</option>
                <option value="sold">Sold</option>
              </select>
            </div>
          </div>

          <!-- Photo Upload -->
          <div class="mb-4">
            <label class="form-label fw-bold">Vehicle Photos</label>
            <input type="file" class="form-control" id="photos" multiple accept="image/*">
            <div class="form-text">Upload multiple photos. First photo will be the main image.</div>
            <div id="imagePreview" class="image-preview"></div>
          </div>

          <!-- Submit Button -->
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
              </svg>
              Add Vehicle to Inventory
            </button>
            <button type="button" class="btn btn-outline-secondary" id="exportBtn">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
              </svg>
              Export JSON for Website
            </button>
          </div>
        </form>
      </div>

      <!-- Preview Panel -->
      <div class="col-lg-4">
        <div class="vehicle-preview sticky-top" style="top: 2rem;">
          <h3 class="h5 mb-3">Preview</h3>
          <div id="preview">
            <div class="text-center text-muted py-5">
              <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="opacity-25">
                <rect x="1" y="3" width="15" height="13" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
                <circle cx="5.5" cy="14.5" r="1.5" fill="currentColor"/>
                <circle cx="12.5" cy="14.5" r="1.5" fill="currentColor"/>
              </svg>
              <p class="mt-3">Fill in vehicle details to see preview</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global vehicle data
    let vehicleData = {};
    let decodedVinData = {};

    // VIN Decoder
    document.getElementById('decodeBtn').addEventListener('click', async function() {
      const vinInput = document.getElementById('vin');
      const vin = vinInput.value.trim().toUpperCase();
      const spinner = document.getElementById('decodeSpinner');
      const btn = this;
      const errorDiv = document.getElementById('vinError');

      // Validate VIN
      if (vin.length !== 17) {
        vinInput.classList.add('is-invalid');
        errorDiv.textContent = 'VIN must be exactly 17 characters';
        return;
      }

      // Remove invalid state
      vinInput.classList.remove('is-invalid');
      errorDiv.textContent = '';

      // Show loading
      btn.disabled = true;
      spinner.classList.remove('d-none');

      try {
        // Call NHTSA API (Free US Government API)
        const response = await fetch(
          `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVin/${vin}?format=json`
        );
        const data = await response.json();
        
        if (data.Results) {
          decodedVinData = data.Results;
          displayDecodedData(decodedVinData);
          populateForm(decodedVinData);
          
          // Show success
          document.getElementById('decodedData').classList.remove('d-none');
        } else {
          throw new Error('Invalid response from VIN decoder');
        }

      } catch (error) {
        alert('Error decoding VIN: ' + error.message + '\n\nPlease check the VIN and try again.');
        console.error('VIN Decode Error:', error);
      } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
      }
    });

    // Helper function to extract value from NHTSA response
    function getValue(results, variableName) {
      const item = results.find(r => r.Variable === variableName);
      return item && item.Value && item.Value !== 'Not Applicable' ? item.Value : '';
    }

    // Display decoded data
    function displayDecodedData(results) {
      document.getElementById('decodedYear').textContent = getValue(results, 'Model Year') || '-';
      document.getElementById('decodedMake').textContent = getValue(results, 'Make') || '-';
      document.getElementById('decodedModel').textContent = getValue(results, 'Model') || '-';
      document.getElementById('decodedTrim').textContent = getValue(results, 'Trim') || '-';
      document.getElementById('decodedBody').textContent = getValue(results, 'Body Class') || '-';
      document.getElementById('decodedDrive').textContent = getValue(results, 'Drive Type') || '-';
      document.getElementById('decodedFuel').textContent = getValue(results, 'Fuel Type - Primary') || '-';
    }

    // Populate form with decoded data
    function populateForm(results) {
      document.getElementById('year').value = getValue(results, 'Model Year');
      document.getElementById('make').value = getValue(results, 'Make');
      document.getElementById('model').value = getValue(results, 'Model');
      document.getElementById('trim').value = getValue(results, 'Trim');

      // Auto-generate description
      const engine = getValue(results, 'Engine Model');
      const displacement = getValue(results, 'Displacement (L)');
      const drive = getValue(results, 'Drive Type');
      const cylinders = getValue(results, 'Engine Number of Cylinders');
      
      let descParts = [];
      if (drive) descParts.push(drive);
      if (displacement && cylinders) descParts.push(`${displacement}L ${cylinders}-Cyl`);
      else if (engine) descParts.push(engine);
      
      if (descParts.length > 0) {
        document.getElementById('description').value = descParts.join(', ');
      }

      // Auto-select type based on body class
      const bodyClass = getValue(results, 'Body Class').toLowerCase();
      let type = '';
      if (bodyClass.includes('truck') || bodyClass.includes('pickup')) type = 'truck';
      else if (bodyClass.includes('suv') || bodyClass.includes('sport utility')) type = 'suv';
      else if (bodyClass.includes('sedan') || bodyClass.includes('coupe')) type = 'car';
      else if (bodyClass.includes('van')) type = 'van';
      
      if (type) document.getElementById('type').value = type;

      // Check if diesel
      const fuelType = getValue(results, 'Fuel Type - Primary').toLowerCase();
      if (fuelType.includes('diesel')) {
        document.getElementById('type').value = 'diesel';
      }

      updatePreview();
    }

    // Image preview
    document.getElementById('photos').addEventListener('change', function(e) {
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      
      const files = Array.from(e.target.files);
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.title = `Image ${index + 1}${index === 0 ? ' (Main)' : ''}`;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // Update preview on form changes
    const formInputs = document.querySelectorAll('#vehicleForm input, #vehicleForm select, #vehicleForm textarea');
    formInputs.forEach(input => {
      input.addEventListener('input', updatePreview);
      input.addEventListener('change', updatePreview);
    });

    function updatePreview() {
      const year = document.getElementById('year').value;
      const make = document.getElementById('make').value;
      const model = document.getElementById('model').value;
      const trim = document.getElementById('trim').value;
      const price = document.getElementById('price').value;
      const description = document.getElementById('description').value;
      const badge = document.getElementById('badge').value;
      const type = document.getElementById('type').value;
      const features = document.getElementById('features').value;

      if (!year || !make || !model || !price) {
        return;
      }

      const featureArray = features ? features.split(',').map(f => f.trim()).filter(f => f) : [];

      const preview = document.getElementById('preview');
      preview.innerHTML = `
        <article class="card shadow-sm h-100">
          ${badge ? `
          <div style="position: relative;">
            <span class="badge bg-${badge === 'Diesel' ? 'warning text-dark' : badge === 'Low Miles' ? 'success' : 'danger'}" 
                  style="position: absolute; top: 0.5rem; left: 0.5rem; z-index: 1;">
              ${badge}
            </span>
          </div>
          ` : ''}
          <div class="bg-light d-flex align-items-center justify-content-center" style="height:180px;">
            <svg width="48" height="48" fill="#999" viewBox="0 0 16 16">
              <rect x="1" y="3" width="15" height="13" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
              <circle cx="5.5" cy="14.5" r="1.5" fill="currentColor"/>
              <circle cx="12.5" cy="14.5" r="1.5" fill="currentColor"/>
            </svg>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h3 class="h6 fw-bold mb-0">${year} ${make} ${model}${trim ? ' ' + trim : ''}</h3>
              <span class="badge bg-danger">$${price ? parseInt(price).toLocaleString() : '0'}</span>
            </div>
            <p class="text-muted small mb-2">${description || 'No description'}</p>
            ${featureArray.length > 0 ? `
            <div class="d-flex flex-wrap gap-1 mb-3">
              ${featureArray.slice(0, 3).map(f => `
                <span class="badge bg-light text-dark border">${f}</span>
              `).join('')}
            </div>
            ` : ''}
            <a href="#" class="btn btn-sm btn-outline-dark w-100">Inquire About This Vehicle</a>
          </div>
        </article>
      `;
    }

    // Form submission
    document.getElementById('vehicleForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Collect all form data
      const formData = {
        vin: document.getElementById('vin').value.trim().toUpperCase(),
        year: parseInt(document.getElementById('year').value),
        make: document.getElementById('make').value,
        model: document.getElementById('model').value,
        trim: document.getElementById('trim').value,
        price: parseInt(document.getElementById('price').value),
        mileage: parseInt(document.getElementById('mileage').value),
        type: document.getElementById('type').value,
        exteriorColor: document.getElementById('exteriorColor').value,
        interiorColor: document.getElementById('interiorColor').value,
        transmission: document.getElementById('transmission').value,
        description: document.getElementById('description').value,
        features: document.getElementById('features').value.split(',').map(f => f.trim()).filter(f => f),
        badge: document.getElementById('badge').value,
        status: document.getElementById('status').value,
        dateAdded: new Date().toISOString(),
        images: [] // Add filenames after uploading photos to assets/vehicles/
      };

      // Store in vehicleData
      vehicleData = formData;

      // Show success message
      alert('Vehicle data prepared!\n\nClick "Export JSON for Website" to download the inventory file.');
      
      
    });

    // Export JSON
    document.getElementById('exportBtn').addEventListener('click', function() {
      if (!vehicleData.vin) {
        alert('Please fill out and submit the form first!');
        return;
      }

      // Create/update inventory JSON structure
      const inventory = {
        lastUpdated: new Date().toISOString(),
        vehicles: [vehicleData] // In production, this would append to existing vehicles
      };

      // Create download
      const dataStr = JSON.stringify(inventory, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'inventory.json';
      link.click();
      URL.revokeObjectURL(url);

      alert('inventory.json downloaded!\n\nUpload this file to your website root directory.');
    });

    // Enter key on VIN field triggers decode
    document.getElementById('vin').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('decodeBtn').click();
      }
    });
  </script>

  <!-- Mobile Quick Actions (Call/Text/Directions) -->
  <nav class="mobile-action-bar d-md-none" aria-label="Quick actions">
    <a class="mobile-action" href="tel:+12524960005">Call</a>
    <a class="mobile-action" href="sms:+12524960005">Text</a>
    <a class="mobile-action"
       href="https://www.google.com/maps?q=3840+Charles+Blvd+Greenville+NC+27858"
       target="_blank" rel="noopener">Directions</a>
  </nav>

</body>
</html>
